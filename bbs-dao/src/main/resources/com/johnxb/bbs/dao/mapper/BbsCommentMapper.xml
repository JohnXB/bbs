<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.johnxb.bbs.dao.mapper.BbsCommentMapper">
    <resultMap id="BaseResultMap" type="com.johnxb.bbs.entity.BbsComment">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="created_at" jdbcType="TIMESTAMP" property="createdAt"/>
        <result column="like_num" jdbcType="INTEGER" property="likeNum"/>
        <result column="article_id" jdbcType="INTEGER" property="articleId"/>
        <result column="parent_id" jdbcType="INTEGER" property="parentId"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="to_user_id" jdbcType="INTEGER" property="toUserId"/>
        <result column="floor" jdbcType="INTEGER" property="floor"/>
        <result column="content" jdbcType="LONGVARCHAR" property="content"/>
    </resultMap>
    <select id="selectAll" resultMap="BaseResultMap">
    select id, created_at, like_num, article_id, parent_id, floor, content
    from bbs_comment
  </select>

    <resultMap id="ArticleInfoMap" type="com.johnxb.bbs.entity.BbsComment">
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="created_at" jdbcType="TIMESTAMP" property="createdAt"/>
        <result column="like_num" jdbcType="INTEGER" property="likeNum"/>
        <result column="article_id" jdbcType="INTEGER" property="articleId"/>
        <result column="parent_id" jdbcType="INTEGER" property="parentId"/>
        <result column="floor" jdbcType="INTEGER" property="floor"/>
        <result column="content" jdbcType="LONGVARCHAR" property="content"/>
        <result column="user_id" jdbcType="INTEGER" property="userId"/>
        <result column="username" property="username"/>
        <result column="to_username" property="toUsername"/>
        <collection property="comment_num" column="id" select="findSonByParentId"/>
    </resultMap>
    <!--文章信息之一级评论集合-->
    <select id="findCommentsByArticleId" resultMap="ArticleInfoMap">
      SELECT bc.id,bc.created_at,bc.like_num,bc.floor,bc.content,
      au.username as username,
      au.id as user_id
      FROM bbs_comment bc
      LEFT JOIN auth_user au ON bc.user_id = au.id
      WHERE #{id} = article_id
      AND parent_id = 0 AND to_user_id is NULL
    </select>

    <select id="findSonByParentId" resultType="java.lang.Integer">
      SELECT count(bc.id)
      FROM bbs_comment bc
      WHERE #{id} = parent_id
    </select>

    <!--<select id="findCommentsByParentId" resultMap="ArticleInfoMap">-->
        <!--SELECT bc.id,bc.created_at,bc.like_num,bc.floor,bc.content,-->
        <!--au.username as username,-->
        <!--toau.username as to_username,-->
        <!--au.id as user_id-->
        <!--FROM bbs_comment bc-->
        <!--LEFT JOIN auth_user au ON bc.user_id = au.id-->
        <!--LEFT JOIN auth_user toau on toau.id = bc.to_user_id-->
        <!--WHERE #{id} = parent_id-->
    <!--</select>-->
</mapper>